name: Frontend - Dev

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - 'helm/charts/microservice/**'
      - 'helm/values/frontend-values.yaml'
      - '.github/workflows/frontend-dev.yaml'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_DEV }}
  GKE_CLUSTER: gke-autopilot-cluster-dev
  GKE_REGION: us-central1
  IMAGE_REGISTRY: gcr.io
  SERVICE_NAME: frontend

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with: { node-version: '18', cache: 'npm' }
    - run: npm ci
    - run: npm run lint
    - run: npm test

  build-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: quality
    steps:
    - uses: actions/checkout@v4
    - uses: google-github-actions/auth@v2
      with: { credentials_json: ${{ secrets.GCP_SA_KEY_DEV }} }
    - run: gcloud auth configure-docker
    - id: meta
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
    
    - uses: docker/setup-buildx-action@v3
    - uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: |
          ${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.meta.outputs.sha_short }}
          ${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:dev-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build-push
    steps:
    - uses: actions/checkout@v4
    - uses: google-github-actions/auth@v2
      with: { credentials_json: ${{ secrets.GCP_SA_KEY_DEV }} }
    - uses: google-github-actions/setup-gcloud@v2
    - run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --region ${{ env.GKE_REGION }} --project ${{ env.GCP_PROJECT_ID }}
    - uses: azure/setup-helm@v3
    - id: meta
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
    
    - name: Deploy
      run: |
        helm upgrade --install ${{ env.SERVICE_NAME }} ./helm/charts/microservice \
          -f ./helm/values/${{ env.SERVICE_NAME }}-values.yaml \
          --set image.tag=${{ steps.meta.outputs.sha_short }} \
          --set image.repository=${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }} \
          -n ${{ env.SERVICE_NAME }} --create-namespace --wait --timeout 5m
