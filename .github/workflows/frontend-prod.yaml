name: Frontend - Prod

on:
  push:
    tags: [ 'frontend-v*' ]  # Trigger on tags like frontend-v1.0.0

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_PROD }}
  GKE_CLUSTER: gke-autopilot-cluster-prod
  GKE_REGION: us-central1
  IMAGE_REGISTRY: gcr.io
  SERVICE_NAME: frontend

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with: { node-version: '18', cache: 'npm' }
    - run: npm ci
    - run: npm run lint
    - run: npm test
    - run: npm run build

  build-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: quality
    steps:
    - uses: actions/checkout@v4
    - uses: google-github-actions/auth@v2
      with: { credentials_json: ${{ secrets.GCP_SA_KEY_PROD }} }
    - run: gcloud auth configure-docker
    - id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.version.outputs.version }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'

    - uses: docker/setup-buildx-action@v3
    - uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: |
          ${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.version.outputs.version }}
          ${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    needs: build-push
    environment: production
    steps:
    - uses: actions/checkout@v4
    - uses: google-github-actions/auth@v2
      with: { credentials_json: ${{ secrets.GCP_SA_KEY_PROD }} }
    - uses: google-github-actions/setup-gcloud@v2
    - run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --region ${{ env.GKE_REGION }} --project ${{ env.GCP_PROJECT_ID }}
    - uses: azure/setup-helm@v3
    - id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Deploy
      run: |
        helm upgrade --install ${{ env.SERVICE_NAME }} ./helm/charts/microservice \
          -f ./helm/values/${{ env.SERVICE_NAME }}-values.yaml \
          -f ./helm/values/${{ env.SERVICE_NAME }}-prod.yaml \
          --set image.tag=${{ steps.version.outputs.version }} \
          --set image.repository=${{ env.IMAGE_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }} \
          -n ${{ env.SERVICE_NAME }} --create-namespace --wait --timeout 10m --atomic

    - name: Create Release
      uses: actions/create-release@v1
      env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: Release ${{ steps.version.outputs.version }}
        body: "Deployed ${{ env.SERVICE_NAME }} to production."
