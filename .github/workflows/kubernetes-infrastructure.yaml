name: Kubernetes Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: string

env:
  GKE_REGION: us-central1

jobs:
  deploy-infrastructure:
    name: Deploy K8s Infrastructure - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'production' || 'development' }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ inputs.environment == 'prod' && secrets.GCP_SA_KEY_PROD || secrets.GCP_SA_KEY_DEV }}
    
    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials gke-autopilot-cluster-${{ inputs.environment }} \
          --region ${{ env.GKE_REGION }} \
          --project ${{ inputs.environment == 'prod' && secrets.GCP_PROJECT_ID_PROD || secrets.GCP_PROJECT_ID_DEV }}
    
    - name: Verify Cluster Connection
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Deploy Gateway Namespace
      run: kubectl apply -f kubernetes/gateway/namespace.yaml
    
    - name: Deploy Gateway
      run: kubectl apply -f kubernetes/gateway/gateway.yaml
    
    - name: Wait for Gateway to be Ready
      run: |
        echo "Waiting for Gateway to be programmed..."
        kubectl wait --for=condition=Programmed gateway/external-gateway \
          -n gateway-system \
          --timeout=300s || true
        
        # Show Gateway status
        kubectl get gateway -n gateway-system
        kubectl describe gateway external-gateway -n gateway-system
    
    - name: Deploy Application Namespaces
      run: kubectl apply -f kubernetes/namespaces/
    
    - name: Deploy External Secrets (if exists)
      run: |
        if [ -d "kubernetes/external-secrets" ]; then
          kubectl apply -f kubernetes/external-secrets/
        else
          echo "External Secrets directory not found, skipping..."
        fi
      continue-on-error: true
    
    - name: Deploy Network Policies (if exists)
      run: |
        if [ -d "kubernetes/network-policies" ]; then
          kubectl apply -f kubernetes/network-policies/
        else
          echo "Network Policies directory not found, skipping..."
        fi
      continue-on-error: true
    
    - name: Get Gateway IP Address
      id: gateway-ip
      run: |
        echo "Waiting for Gateway IP address..."
        for i in {1..30}; do
          IP=$(kubectl get gateway external-gateway -n gateway-system -o jsonpath='{.status.addresses[0].value}' 2>/dev/null || echo "")
          if [ -n "$IP" ]; then
            echo "Gateway IP: $IP"
            echo "ip=$IP" >> $GITHUB_OUTPUT
            break
          fi
          echo "Attempt $i: IP not ready yet, waiting..."
          sleep 10
        done
    
    - name: Deployment Summary
      run: |
        echo "## Kubernetes Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Gateway Status" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        kubectl get gateway -n gateway-system >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Gateway IP Address:** ${{ steps.gateway-ip.outputs.ip }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Namespaces" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        kubectl get namespaces >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Update DNS records to point to Gateway IP: ${{ steps.gateway-ip.outputs.ip }}" >> $GITHUB_STEP_SUMMARY
        echo "2. Deploy applications using Helm (backend-${{ inputs.environment }}.yaml and frontend-${{ inputs.environment }}.yaml workflows)" >> $GITHUB_STEP_SUMMARY
